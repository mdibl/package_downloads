#!/bin/sh

# Organization: MDIBL
# Author: Lucie Hutchins
# Date: October 2017
## Script to build and install a new R package
# What it does:
# 1) source the main config file to set gloabl path
# 2) untar the downloaded tar file
# 3) builds and install R
#
# Note: the following environment variables are expected to be set
# by the caller
# 1) GLOBAL_CONFIG
# 2) PACKAGE_BASE
#
cd `dirname $0`
SCRIPT_NAME=`basename $0`
WORKING_DIR=`pwd`
TAR=`which tar`
echo "==" 
echo "Server Name: `uname -n`" 
echo "Install Date: `date`" 
if [ ! -f ../${GLOBAL_CONFIG} ]
then
  echo "'../${GLOBAL_CONFIG}' file missing "     
  exit 1
fi
source ./../${GLOBAL_CONFIG}
if [ ! -f ${PACKAGE_DEPENDENCIES_FILE} ]
then
   echo "ERROR: ${PACKAGE_DEPENDENCIES_FILE} file missing"
   exit 1
fi
source ./${PACKAGE_DEPENDENCIES_FILE}
if [ ! -d ${PACKAGE_BASE} ]
then
   echo "ERROR: Missing the install directory ${PACKAGE_BASE} "
   exit 1
fi
RELEASE_DIR=`basename ${PACKAGE_BASE}`
cd ${PACKAGE_BASE}
#
# as defined in the package config file
if [ ! -f ${REMOTE_FILES} ]
then
   echo "ERROR - tar file:${REMOTE_FILES} missing under `pwd`"
   exit 1 
fi
echo "Running ${TAR} -xvf ${REMOTE_FILES} command from "`pwd` 
${TAR} -xvf ${REMOTE_FILES} 2>&1 
if [ ! -d ${RELEASE_DIR} ]
then
   rstatus="FAILED"
   echo "Command $TAR -xvf $REMOTE_FILES failed - missing directory ${RELEASE_DIR}"
   exit 1
fi
mv ${RELEASE_DIR}/* .
rm -rf ${RELEASE_DIR}/
#cleanup the tar file
rm -f $REMOTE_FILES
echo "Running the install from "`pwd` 
./configure --prefix=$SOFTWARE_BASE --with-x=no
make
make install

#make install-info
#make install-pdf
exit 0

